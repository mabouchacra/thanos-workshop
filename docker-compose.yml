version: "3"

services:

  crawler-cli1:
    image: quay.io/prometheus/prometheus:v2.20.0
    volumes:
      - "./prom-cli1-config.yml:/etc/prometheus/prometheus.yml"
      - "./data/prom-cli1-dc1:/prometheus"
    user: root
    ports:
      - "${PROM_CLI1_0_PORT}:${PROM_CLI1_0_PORT}"
    command: ["--config.file=/etc/prometheus/prometheus.yml", 
    "--storage.tsdb.path=/prometheus",
    "--storage.tsdb.retention.time=1000d", 
    "--storage.tsdb.max-block-duration=2h", 
    "--storage.tsdb.min-block-duration=2h", 
    "--web.listen-address=:$PROM_CLI1_0_PORT", 
    "--web.external-url=${PROM_CLI1_0_EXT_ADDRESS}:$PROM_CLI1_0_PORT", 
    "--web.enable-lifecycle", 
    "--web.enable-admin-api"]

  crawler-cli2:
    image: quay.io/prometheus/prometheus:v2.20.0
    volumes:
      - "./prom-cli2-config.yml:/etc/prometheus/prometheus.yml"
      - "./data/prom-cli2-dc1:/prometheus"
    user: root
    ports:
      - "${PROM_CLI2_0_PORT}:${PROM_CLI2_0_PORT}"
    command: ["--config.file=/etc/prometheus/prometheus.yml", 
    "--storage.tsdb.path=/prometheus",
    "--storage.tsdb.retention.time=1000d", 
    "--storage.tsdb.max-block-duration=2h", 
    "--storage.tsdb.min-block-duration=2h", 
    "--web.listen-address=:$PROM_CLI2_0_PORT", 
    "--web.external-url=${PROM_CLI2_0_EXT_ADDRESS}:$PROM_CLI2_0_PORT", 
    "--web.enable-lifecycle", 
    "--web.enable-admin-api"]

  sidecar-cli1:
    image: quay.io/thanos/thanos:v0.16.0
    volumes:
      - "./prom-cli1-config.yml:/etc/prometheus/prometheus.yml"
    user: root
    command: "sidecar --http-address 0.0.0.0:19091 \
    --grpc-address 0.0.0.0:19191 \
    --reloader.config-file /etc/prometheus/prometheus.yml \
    --prometheus.url http://crawler-cli1:${PROM_CLI1_0_PORT}"

  sidecar-cli2:
    image: quay.io/thanos/thanos:v0.16.0
    volumes:
      - "./prom-cli2-config.yml:/etc/prometheus/prometheus.yml"
    user: root
    command: "sidecar --http-address 0.0.0.0:19092 \
    --grpc-address 0.0.0.0:19192 \
    --reloader.config-file /etc/prometheus/prometheus.yml \
    --prometheus.url http://crawler-cli2:${PROM_CLI2_0_PORT}"

  global-query:
    image: quay.io/thanos/thanos:v0.16.0
    volumes:
      - "./prom-cli2-config.yml:/etc/prometheus/prometheus.yml"
    user: root
    ports:
      - "9090:9090"
    command: "query \
    --http-address 0.0.0.0:9090 \
    --grpc-address 0.0.0.0:19190 \
    --query.replica-label replica \
    --log.level=debug
    --store sidecar-cli1:19191 \
    --store sidecar-cli2:19192"

#  prom-proxy:
#    image: quay.io/thanos/prom-label-proxy:v0.3.0-rc.0-ext1
#    ports:
#      - "39090:39090"
#    command: "-label client \
#    -upstream http://global-query:9090 \
#    -insecure-listen-address 0.0.0.0:39090 \
#    -non-api-path-passthrough \
#    -enable-label-apis"

  grafana:
    image: grafana/grafana:7.2.1
    ports:
      - "3000:3000"